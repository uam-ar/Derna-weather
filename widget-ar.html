<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø·Ù‚Ø³ Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ â€“ Ø¬Ø§Ù…Ø¹Ø© Ø¯Ø±Ù†Ø©</title>

  <style>
    :root{
      --card-bg: #f5f4ef;
      --border: rgba(0,0,0,.10);
      --text: #111;
      --muted: rgba(0,0,0,.65);
      --muted2: rgba(0,0,0,.45);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
    }
    html, body { margin:0; padding:0; background: transparent; color: var(--text); font-family: system-ui, "Tahoma", "Arial", sans-serif; }

    .card{
      width:100%;
      max-width: 860px;
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-direction: row-reverse;
    }

    .titleWrap{ display:flex; flex-direction: column; gap: 4px; text-align: right; }
    .title{ font-size: 20px; font-weight: 900; }
    .subtitle{ font-size: 12px; color: var(--muted); }

    .pill{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.6);
      white-space: nowrap;
      font-weight: 650;
      color: rgba(0,0,0,.75);
    }

    .status{ font-size: 12px; color: var(--muted); margin-top: 6px; text-align:right; }

    .nowRow{
      display:flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.55);
      flex-direction: row-reverse;
    }

    .bigIcon{
      width: 52px; height: 52px;
      display:grid; place-items:center;
      font-size: 30px;
      border-radius: 14px;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.06);
      flex: 0 0 auto;
    }

    .nowMain{ flex: 1 1 auto; min-width: 0; text-align:right; }
    .nowLine{ font-size: 16px; font-weight: 800; line-height: 1.25; margin-bottom: 4px; }

    .nowMeta{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.3;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
    }

    .sparkWrap{
      flex: 0 0 170px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-start;
    }
    .sparkLabel{ font-size: 12px; color: var(--muted2); font-weight: 700; text-align:left; }
    canvas{ display:block; }

    .alerts{
      display:none;
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255, 235, 59, 0.18);
    }
    .alerts .hdr{ font-weight: 900; display:flex; align-items:center; gap: 8px; margin-bottom: 6px; }
    .alertItem{ margin-top: 8px; padding-top: 8px; border-top: 1px dashed rgba(0,0,0,.18); }
    .alertName{ font-weight: 800; }
    .alertMeta{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .alertDesc{ font-size: 13px; margin-top: 6px; line-height: 1.35; color: rgba(0,0,0,.85); }

    .sectionTitle{ font-weight: 900; margin-top: 14px; margin-bottom: 8px; font-size: 14px; text-align: right; }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: rgba(255,255,255,.35);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    thead th{
      text-align:right;
      font-weight: 800;
      color: rgba(0,0,0,.75);
      background: rgba(0,0,0,.03);
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
    }
    tbody td{ padding: 9px 10px; border-bottom: 1px solid rgba(0,0,0,.06); vertical-align: middle; text-align:right; }
    tbody tr:last-child td{ border-bottom: none; }

    .r{ text-align:left; }
    .cond{ display:flex; align-items:center; gap: 8px; white-space: nowrap; flex-direction: row-reverse; justify-content: flex-end; }
    .cond .sIcon{ font-size: 16px; }

    .footer{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      flex-direction: row-reverse;
    }

    .disclaimer{ margin-top: 8px; font-size: 12px; color: var(--muted2); line-height: 1.35; text-align:right; }
  </style>
</head>

<body>
  <div class="card">
    <div class="header">
      <div class="titleWrap">
        <div class="title">Ø·Ù‚Ø³ Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ â€“ Ø¬Ø§Ù…Ø¹Ø© Ø¯Ø±Ù†Ø©</div>
        <div class="subtitle">ØªÙˆÙ‚Ø¹Ø§Øª ÙˆÙ†Ù…Ø°Ø¬Ø© (Open-Meteo) + ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø±Ø³Ù…ÙŠØ© (CAP)</div>
      </div>
      <div id="locPill" class="pill">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
    </div>

    <div id="status" class="status">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>

    <div id="alerts" class="alerts">
      <div class="hdr">ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„ÙŠØ¨ÙŠØ§ (Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„Ø£Ø±ØµØ§Ø¯)</div>
      <div id="alertsBody"></div>
    </div>

    <div id="nowBlock"></div>

    <div class="sectionTitle">ØªÙˆÙ‚Ø¹Ø§Øª 7 Ø£ÙŠØ§Ù…</div>
    <div id="forecast"></div>

    <div class="footer">
      <div id="updated"></div>
      <div id="source"></div>
    </div>

    <div class="disclaimer">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù† ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø®Ø±Ø¬Ø§Øª Ù†Ù…Ø§Ø°Ø¬ Ø¹Ø¯Ø¯ÙŠØ© ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª CAP Ø§Ù„Ø±Ø³Ù…ÙŠØ©.
    </div>
  </div>

<script>
(function(){
  var WEATHER_JSON_URL = "./weather.json";
  var ALERTS_JSON_URL = "./alerts.json";

  // Optional: Arabic digits (set true for Ù¡Ù¢Ù£)
  var USE_ARABIC_DIGITS = false;

  function cToF(c){ return (c * 9 / 5) + 32; }
  function safe(v){ return (v === null || v === undefined) ? "â€”" : v; }

  function toArabicDigits(s){
    if (!USE_ARABIC_DIGITS) return String(s);
    var map = {"0":"Ù ","1":"Ù¡","2":"Ù¢","3":"Ù£","4":"Ù¤","5":"Ù¥","6":"Ù¦","7":"Ù§","8":"Ù¨","9":"Ù©","-":"âˆ’",".":"Ù«"};
    return String(s).replace(/[0-9\-.]/g, function(ch){ return map[ch] || ch; });
  }

  function icon(code){
    if (code === 0) return "â˜€ï¸";
    if (code === 1 || code === 2) return "ğŸŒ¤ï¸";
    if (code === 3) return "â˜ï¸";
    if (code >= 45 && code <= 48) return "ğŸŒ«ï¸";
    if (code >= 51 && code <= 57) return "ğŸŒ¦ï¸";
    if (code >= 61 && code <= 67) return "ğŸŒ§ï¸";
    if (code >= 71 && code <= 77) return "â„ï¸";
    if (code >= 80 && code <= 82) return "ğŸŒ¦ï¸";
    if (code >= 95) return "â›ˆï¸";
    return "ğŸŒ¥ï¸";
  }

  function labelAr(code){
    if (code === 0) return "ØµØ­Ùˆ";
    if (code === 1 || code === 2) return "ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹";
    if (code === 3) return "ØºØ§Ø¦Ù…";
    if (code >= 45 && code <= 48) return "Ø¶Ø¨Ø§Ø¨";
    if (code >= 51 && code <= 57) return "Ø±Ø°Ø§Ø°";
    if (code >= 61 && code <= 67) return "Ø£Ù…Ø·Ø§Ø±";
    if (code >= 71 && code <= 77) return "Ø«Ù„ÙˆØ¬";
    if (code >= 80 && code <= 82) return "Ø²Ø®Ø§Øª";
    if (code >= 95) return "Ø¹ÙˆØ§ØµÙ Ø±Ø¹Ø¯ÙŠØ©";
    return "Ù…ØªÙ‚Ù„Ø¨";
  }

  function isoDateLocal(){
    var d = new Date();
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,"0");
    var day = String(d.getDate()).padStart(2,"0");
    return y + "-" + m + "-" + day;
  }

  function drawSparkline(canvas, values){
    var ctx = canvas.getContext("2d");
    var w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    if (!values || values.length < 2) return;

    var min = Infinity, max = -Infinity;
    values.forEach(function(v){
      if (v == null) return;
      min = Math.min(min, v);
      max = Math.max(max, v);
    });
    if (min === max) { min -= 1; max += 1; }

    function x(i){ return (i/(values.length-1)) * (w-10) + 5; }
    function y(v){ return (h-8) - ((v-min)/(max-min))*(h-16) + 4; }

    ctx.beginPath();
    values.forEach(function(v,i){
      if (v == null) return;
      var px = x(i), py = y(v);
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    });
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.stroke();

    values.forEach(function(v,i){
      if (v == null) return;
      ctx.beginPath();
      ctx.arc(x(i), y(v), 3.5, 0, Math.PI*2);
      ctx.fillStyle = "#111";
      ctx.fill();
    });
  }

  // 1) Weather
  fetch(WEATHER_JSON_URL, { cache: "no-store" })
    .then(function(r){ if(!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(function(data){
      document.getElementById("status").textContent = "";

      var cur = data.current || {};
      var daily = data.daily || [];
      var meta = data.meta || {};

      document.getElementById("locPill").textContent = meta.place_name || "Ø§Ù„Ù…ÙˆÙ‚Ø¹";

      var tC = cur.temperature_c;
      var feelsC = cur.feels_like_c;

      var nowHtml =
        "<div class='nowRow'>" +
          "<div class='bigIcon' aria-hidden='true'>" + icon(cur.weather_code) + "</div>" +
          "<div class='nowMain'>" +
            "<div class='nowLine'>Ø§Ù„Ø¢Ù†: " +
              toArabicDigits(safe(tC==null?null:tC.toFixed(1))) + "Â°Ù…" +
              " â€¢ " + labelAr(cur.weather_code) +
            "</div>" +
            "<div class='nowMeta'>" +
              "<span>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: <strong>" + toArabicDigits(safe(cur.humidity_pct)) + "%</strong></span>" +
              "<span>Ø§Ù„Ø±ÙŠØ§Ø­: <strong>" + toArabicDigits(safe(cur.wind_speed_kmh)) + " ÙƒÙ…/Ø³</strong></span>" +
              "<span>Ø§Ù„Ù…Ø­Ø³ÙˆØ³: <strong>" + toArabicDigits(safe(feelsC==null?null:feelsC.toFixed(1))) + "Â°Ù…</strong></span>" +
            "</div>" +
          "</div>" +
          "<div class='sparkWrap'>" +
            "<div class='sparkLabel'>Ø§Ù„Ø¹Ø¸Ù…Ù‰ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… (Â°Ù…)</div>" +
            "<canvas id='spark' width='170' height='42'></canvas>" +
          "</div>" +
        "</div>";

      document.getElementById("nowBlock").innerHTML = nowHtml;

      var today = isoDateLocal();

      var rows = daily.slice(0,7).map(function(d){
        var isToday = (d.date === today);
        return "<tr class='" + (isToday ? "today" : "") + "'>" +
          "<td>" + toArabicDigits(safe(d.date)) + "</td>" +
          "<td><div class='cond'><span class='sIcon'>" + icon(d.weather_code) + "</span><span>" + labelAr(d.weather_code) + "</span></div></td>" +
          "<td class='r'>" + toArabicDigits(safe(d.tmax_c==null?null:d.tmax_c.toFixed(0))) + " / " + toArabicDigits(safe(d.tmin_c==null?null:d.tmin_c.toFixed(0))) + "Â°Ù…</td>" +
          "<td class='r'>" + toArabicDigits(safe(d.precip_prob_pct)) + "%</td>" +
        "</tr>";
      }).join("");

      document.getElementById("forecast").innerHTML =
        "<table><thead><tr>" +
          "<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class='r'>Ø¹Ø¸Ù…Ù‰ / ØµØºØ±Ù‰</th><th class='r'>Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø·Ø±</th>" +
        "</tr></thead><tbody>" + rows + "</tbody></table>";

      var highsC = daily.slice(0,7).map(function(d){ return d.tmax_c; });
      var canvas = document.getElementById("spark");
      if (canvas) drawSparkline(canvas, highsC);

      document.getElementById("updated").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« (UTC): " + toArabicDigits(safe(meta.generated_utc));
      document.getElementById("source").textContent = "Ø§Ù„Ù…ØµØ¯Ø±: " + safe(meta.source);

      // 2) Alerts (from alerts.json generated by Actions)
      return fetch(ALERTS_JSON_URL, { cache: "no-store" });
    })
    .then(function(r){
      if (!r || !r.ok) throw new Error("Alerts unavailable");
      return r.json();
    })
    .then(function(alertsData){
      var alerts = (alertsData && alertsData.alerts) ? alertsData.alerts : [];
      if (!alerts.length) return;

      var html = alerts.slice(0,3).map(function(a){
        var title = a.title || "ØªÙ†Ø¨ÙŠÙ‡";
        var pub = a.published || "";
        var sum = a.summary || "";

        // Keep it short
        if (sum.length > 320) sum = sum.slice(0,319) + "â€¦";

        return "<div class='alertItem'>" +
          "<div class='alertName'>âš ï¸ " + title + "</div>" +
          (pub ? "<div class='alertMeta'>Ø§Ù„ØªØ§Ø±ÙŠØ®: " + pub + "</div>" : "") +
          (sum ? "<div class='alertDesc'>" + sum.replace(/\n/g,"<br>") + "</div>" : "") +
        "</div>";
      }).join("");

      document.getElementById("alertsBody").innerHTML = html;
      document.getElementById("alerts").style.display = "block";
    })
    .catch(function(e){
      // If weather fails, show error; if alerts fail, ignore.
      var s = document.getElementById("status");
      if (s && s.textContent === "") return; // weather OK, alerts failed
      document.getElementById("status").textContent = "ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù‚Ø³ (" + (e && e.message ? e.message : "Ø®Ø·Ø£") + ").";
    });
})();
</script>
</body>
</html>
